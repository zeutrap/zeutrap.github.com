---
layout: post
title: "Amazon架构"
description: ""
category: "architecture"
tags: ["all-time-favorites系列", "一日一架构", "架构", "译文"]
---
{% include JB/setup %}

本文翻译自 HighScalability.com的[Amazon Architecture](http://highscalability.com/amazon-architecture)一文。

##信息源  
* Greg Linden的[Early Amazon](http://glinden.blogspot.com/2006/05/early-amazon-end.html)  
* [How Linux saved Amazon millions](http://news.com.com/2100-1001-275155.html)  
* [Interview Werner Vogels](http://www.se-radio.net/index.php?post_id=157593)  
* Chiris Loosley的[异步架构-Werner Vogels演讲摘要](http://www.webperformancematters.com/journal/2007/8/21/asynchronous-architectures-4.html)  
* [Learning from the Amazon technology platform](http://www.acmqueue.com/modules.php?name=Content&pa=showpage&pid=388) 
* [Werner Vogels的博客](http://www.allthingsdistributed.com/)  

##平台
* Linux
* Oracle
* C++
* Perl
* Mason
* Java
* Jboss
* Servlets

##数字  
* 超过5千5百万活跃买家。
* 世界范围内超过了1百万活跃零售合作伙伴。  
* 每个页面的组成都访问了100-150个服务。  

##架构
* 扩展性真正意味着什么？一个服务能够通过增加系统的资源从而成比例地提高系统性能，那么它就可以被成为可扩展的。提高性能通常意味着能够为更多单元提供服务，但也能够处理更大单元，比如处理数据库的增长。  
* Amazon所做的一个大的架构调整是从一个两层的庞然大物转变成一个完全分布式、去中心化、为大量不同应用提供服务的平台。  
* 从一个与后端进行通信的应用开始。它是用C++写的。  
* 它在增长。多年来，Amazon为扩展所做的努力集中在扩展后端的数据库，使之能处理更多的商品，更多的客户，更多的订单以及支持多个国际性站点。在2001年的时候，我们清楚的看到前端应用再也不能够进行扩展了。数据库被切分成很多个小的部分，并且为每个部分创建一个服务接口，这是访问数据的唯一途径。  
* 数据库变成了共享资源，这使得很难去扩展整个事情。前端和后端的处理在他们的迭代中被严格受限，因为这是被很多不同的团队和处理所共享的。  
* 架构是基于服务创建的，是松耦合的。一个基于服务的架构给他们提供了隔离性，这样能够让很多软件模块能够快速独立地构建。  
* 于是长成了数百个服务以及一些用来聚合服务数据的应用服务器。渲染Amazon.com网站页面的应用就是这样的一个应用服务器。网页服务接口、消费者服务应用和卖家接口也都如此。  
* 大量的第三方技术阻碍了Amazon大小的扩展。尤其是通信基础设施技术。在一定规模下它们工作的很好，但再大就出错了。所以他们必须自己创建。  
* 不坚持使用一个特别的方法。有的地方他们使用了jboss/java，但是他们只使用serlets，而不是用J2EE的其他东西。  
* 使用C++处理请求。Perl/Mason用来构建内容。  
* Amazon不喜欢中间件，因为它往往是框架而不是工具。如果你使用了一个中间件的包，你就被困在了他们所选择的软件模式里面了。你只能使用他们的软件。所以如果你想要使用不同的包那你就不能这样做。这太恶心了。比如消息传输重的事件循环，数据持久化，AJAX等等。太复杂了。如果中间件能够变成更小的组件，更像一个工具而不是像一个框架，那么这些都会变的更有趣。  
* SOAP的网络堆栈看起来想一次性解决所有的分布式系统问题问题。  
* 提供SOAP和REST两种服务。30%使用SOAP。这往往是Java或者.Net的用户，他们使用WSDL文件来生成远程对象接口。70%使用REST。这往往是PHP或者PERL用户。  
* 不管是SOAP还是REST的服务开发者都能从Amaon获得一个对象接口。开发者只想把任务做完，他们并不关心网线那边到底发生了什么。  
* Amazon想围绕他们的服务建立一个开发的社区。因为简单选择了网页服务。但是这仅仅是面向外面的客户。内部则是一个面向服务的架构。你只能通过接口来访问数据。接口在WSDL里面描述，但是他们使用自己的封装和传输机制。  
* 团队是精小和围绕服务组织的。  
  -- 服务是Amazon里独立提供功能的单位。这也是Amazon内部组织的方式。  
  -- 如果你有新的商业想法或者问题想要解决，那么你组建一个团队。为了沟通方便限制一个团队的人数为8-10人。这被称之为“两个匹萨”团队。因为这么多的人正好能够吃两个匹萨。  
  -- 团队是短小的。他们被授权使用任何他们觉得合适的方法作为一个服务来解决问题。  
  -- 举个例子来说，他们创建了一个团队来寻找书中唯一存在的短语。这个团队为这个特性创建了一个单独的服务接口。他们被授权去做任何他们觉得需要做的事情。  
  -- 广泛的A/B测试被用来整合一个新的服务。他们看看会造成什么影响，然后在进行全面的衡量。  
* 部署  
  -- 他们创建了特殊的基础设施用来管理依赖和进行部署。  
  -- 目的是确保一次性部署所有确切的服务。所有的应用代码，监控，监听等等都应该在一次操作里。  
  -- 每个人都有一个土生土长的系统来解决这些问题。  
  -- 部署过程的输出是一个虚拟机。你可以使用EC2来运行它们。  
* 通过客户的用户反馈来验证一个新服务是否值得。  
  -- 基于用户反馈工作。集中精力在你想要提供给用户的价值上。  
  -- 强迫开发人员关注给客户提供的价值上去，而不是先实现技术然后再指出如何使用这个东西。  
  -- 准备一个用户将要看到的特性清单，然后反过头来检测你正在创建一些有价值的东西。  
  --最终设计要尽可能地小。简单是你想要创建一个大规模分布式系统的关键。  

* 状态管理是大规模可扩展系统的核心问题。  
  -- 在内部可以提供无限的存储。  
  -- 不是所有的操作都是有状态的。结账步骤是有状态的。  
  -- 会基于session ID提供最近点击页面的推荐。  
  -- 他们跟踪了一切东西，所以保存状态是没什么问题的。有很少的独立状态需要保存在session里。服务已经准备好保存消息了，所以你只需要使用这些服务就好了。  
* Eric Brewer的CAP理论：  
  -- 系统的三个属性：一致性、可用性、网络分区的容错性。  
  -- 对于任何共享数据的系统，你最多只能保证这三个属性重的两个。  
  -- 可分区性：将所有结点分成很多个可以与其他分组联系的小分组，但是他们不能联系所有分组。  
  -- 一致性：写入一个之后，你再来读这个值，读出来的值与写的值一样。在分区系统中，这不一定那个是正确的。  
  -- 可用性： 并不是所有的时候都可以写或者读。系统将会告诉你你不能写的原因是因为它要保证系统的一致性。  
  -- 为了扩展，你必须进行分区。所以，接下来你就只能针对特定的系统选择高一致性还是高可用性。你必须在可用性和一致性之间找到适合的平衡点。  
  -- 究竟选择什么基于你服务的需要。  
  -- 对于一个结账过程，你总是想尽量保证能够添加商品到购物车里面。原因是由于这样子会产生收入。在这种情况下，你应该选择高可用性。错误应该对客户隐藏，并能够在接下来的过程中处理掉。  
  -- 当一个客户提交订单时，你更愿意保证一致性。因为这时候很多服务-信用卡处理，物流处理、报表等会同时访问数据。  

##从中学到的  
* 为了建立真正可扩展的系统，你必须转变你的观念。混乱的方法从概率上来说也可能工作的很好。在传统的系统中，我们觉得应该是一个永远不会出错的完美世界，并且我们会在完美世界中构建复杂的算法。反过来，其实失败或者错误是很正常的，这就是现实，你应当拥抱它。举个例子来说，应该使用快速重启和快速恢复的方法。这样的话，你的数据和服务将会得到很好的近乎100%的保证。创建自修复、自组织的方法。  
* 创建一个“无分享”的结构。当你的逻辑层和数据层使用共享资源进行开发和部署时，你的结构也成了一个共享的资源。它有可能会导致上锁、阻塞和思索。一个面向服务的架构允许创建并向和透明的开发过程来进行特性开发以便适应你的增长。  
* 使用API开放你的系统，这样的话你会围绕你的应用创建一个生态系统。  
* 管理大规模分布式系统唯一的方法就是保证尽可能的简单。通过确认在设计中没有隐性需求和依赖来保证简单。将技术精简到解决问题所需要的最小程度。它并不能帮助公司创建不必要的复杂层。  
* 围绕服务来组织能够带来。因为输出是服务，所以你能够并行地做一些事情。这将使得你快速地投入市场。创建一种能够让服务快速构建的架构。  
* 如果在实现前进行炒作的话，一定会带来问题。  
* 内部使用SLA来管理服务。  
* 任何人都能够很快地为他们的产品添加web服务。你只需要将你产品的一部分实现成产品并开始用它就行了。  
* 创建你的基础设施的时候考虑性能、可靠性和成本。如果你自己创建的话，你将永远不能宣称你的失败是由于其他某个公司的问题。你的软件可能没有其他的更可靠，但是你能够比使用第三方库的时候更快地进行修复、调试和部署。  
* 使用指标和客观讨论来区分好和坏。我去过几次前Amazon人的讲座，这正是Amazon让我觉得它与其他公司相比显得独一无二和有趣的地方。他们的准则是让真实用户进行选择，看看哪一种效果会更好。然后再根据他们的测试进行决策。  
  [Avinash Kaushik](http://highscalability.com/blog-occam-s-razor-avinash-kaushik)称之为这是摆脱那些拿着高工资坐办公室的嬉皮士们影响的方法。可以使用像A/B测试和网页分析等技术来做这种事。如果你有一个问题，那么你就进行编码，让人们使用它，然后看看能否带来你想要的结果就好了。  
* 创建一种节俭的文化。比如说，Amazon使用门做桌子。  
* 知道你想要什么。Amazon就有一次早期推荐系统的失败经历。这个系统效果很差。“它根本就不是Amazon想要的。Amazon需要一个能够工作在稀疏数据，只有少量评分和购买的书籍推荐系统。它需要运行的更快。需要能够扩展到海量的客户和巨大的类目上。它要能增加那些深藏在类目深处书籍的曝光率。而这些书籍原本是根本不可能被读者找到的。”  
* 基于人的项目。人们通常会跟随那些他们感兴趣的人，而往往你又能从这些人那获得最大的价值和新鲜感。永远不要低估兴趣的力量。  
* 让每个人都去吃“狗食”。在圣诞节促销的时候，让员工去仓库打包书籍。这就是团队合作。  
* 创建测试框架。这样的话你就能够在发布前测试你的工作能否通过。  
* 一个鲁棒的复制的分布式集群文件系统是非常适合被web服务器用作可读数据处理的。  
* 当升级失败时要有回滚的方法。如果有必要你可以自己写一个工具。  
* 切换到一个[深度基于服务的框架](http://webservices.sys-con.com/read/262024.htm)。
* 面试中会寻找三种东西：积极性、创造性和竞争力。在Amazon.com取得成功的最主要条件是积极性。  
* 我们会雇佣这样的人：有无与伦比的调试技巧和系统知识。最关键的是要有承担高压的能力。  
* 创新只可能来自于基层。最接近问题的人是最适合解决问题的人。任何依赖于创新的组织必须拥抱混乱。忠诚和服从不是你的工具。  
* 创新可能在任何地方出现。  
* 任何人都必须能够做实验、学习和迭代。位置、服从和传统没有任何力量。为了创新的繁荣，测量必须是天条。  
* 拥抱创新。Jeff Bezos会在全公司面前给那些创新的人发一双老款的Nike鞋作为“Just do it”奖。  
* 不要为绩效发工资。保持良好的津贴和高工资，但是要保持平稳。使用其他的方法来表彰出色的工作。绩效工资听起来不错，但是在大的组织里面做到公平几乎不可能。使用非金钱的奖励。比如一双老款鞋。这是一种说“谢谢你”的方法。  
* 快速增长。那些像Barnes和Nobel的大家伙在你的后面。Amaznon以前根本就不是排名第一、第二甚至第三的网上书店，但是他们的愿景让他们赢到最后。  
* 在数据中心，工作人员花在基础架构问题上的时间只有30%是与创造价值有关。而剩下的70%的使用被用来处理繁重的硬件采购，软件管理，负载均衡，保养，扩展性变更等等。  
* 禁止客户端直接访问数据库。这意味着在不涉及你客户的前提下让你的服务更易扩展和更可靠。这很像Google的能力，他们能够独立地改进他们的堆栈使得所有的应用收益。  
* 创建一个唯一统一的服务访问机制。这将提供更容易的服务聚合，请求路由去中心化，分布式请求跟踪和其他高级的基础设施技术。  
* 让世界上任何开发者都能通过Web服务接口的方式访问Amazon.com也取得了巨大的成就。因为它带动很多的创新，而这些创新他们从未想过，也没有自己构建过。  
* 开发者知道哪个工具让他们最有生产力，哪个工具最适合工作。  
* 不要给工程师太多的约束。提供一些激励性的东西，比如将监控系统和其他基础设施工具整合。但是剩下的让团队自己独立地选择。  
* 开发者就像艺术家。当他们感觉到自由的时候他们会贡献出最好的作品。但是他们需要好的工具。有很多自主性的支持工具。围绕服务开发提供一个支持环境，但永远不要去干扰开发者。  
* 谁开发的谁运行。这使得开发人员能够接触到他们软件每天的操作。也使得他们能够每天接触到客户。客户反馈循环能够有效地提升服务的质量。  
* 开发者每两年就应该花大量的时间与客户在一起。他们应当真正接听客户服务电话，回答客户服务邮件以及真正理解作为技术人员做的事造成的影响。  
* 使用“客户之声”。这是一个来自于客户的关于你网站体验的真实故事。这能够帮助经理和工程师能够理解他们是为了真实人群提供技术的。当你做错事或者让客户很难受的时候，客户服务统计是早期的预警工具。  
* Amazon的基础设施就像Google一样是个巨大的竞争优势。他们能够给予原始简单的服务构建出非常复杂的应用。他们能够独立地扩展他们的操作，保持无与伦比的可用性以及快速地推出新的服务而不需要大量的重新配置。


